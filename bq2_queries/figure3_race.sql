#creating the race variable used in plot #3 in stakeholders metrics dashboard
CREATE OR REPLACE TABLE
  `nih-nci-dceg-connect-bq2-prod.StakeHolderMetrics_RS.figure3_race` AS
WITH
  m1_dup AS (
  SELECT
    Connect_ID,
    D_384191091_D_384191091_D_412790539,
    D_384191091_D_384191091_D_458435048,
    D_384191091_D_384191091_D_583826374,
    D_384191091_D_384191091_D_586825330,
    D_384191091_D_384191091_D_973565052,
    D_384191091_D_384191091_D_636411467,
    D_384191091_D_384191091_D_706998638,
    D_384191091_D_384191091_D_746038746,
    D_384191091_D_384191091_D_807835037,
    D_384191091_D_747350323,
    date,
    2 AS version
  FROM
    `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP`
  UNION ALL
  SELECT
    Connect_ID,
    D_384191091_D_384191091_D_412790539,
    D_384191091_D_384191091_D_458435048,
    D_384191091_D_384191091_D_583826374,
    D_384191091_D_384191091_D_586825330,
    D_384191091_D_384191091_D_973565052,
    D_384191091_D_384191091_D_636411467,
    D_384191091_D_384191091_D_706998638,
    D_384191091_D_384191091_D_746038746,
    D_384191091_D_384191091_D_807835037,
    D_384191091_D_747350323,
    date,
    1 AS version
  FROM
    `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v1_JP`
  WHERE
    Connect_ID NOT IN ('7154937817',
      '2801868875',
      '6490089737',
      '2503474663',
      '8381653219',
      '9981369134',
      '5733067482',
      '8903103822',
      '4670161070',
      '6480399310',
      '1322312513',
      '8455823558',
      '5770553465',
      '9325568364',
      '8048162478',
      '6442875968',
      '9425034222',
      '8930825906',
      '1448181276',
      '7666852403',
      '1137648664',
      '4887607966',
      '9050790502',
      '9965993182',
      '4178910664',
      '1035842173',
      '7812456818',
      '5961056153',
      '8824377567',
      '3977547925',
      '4491438652',
      '3934969608',
      '7074192548',
      '4981641476',
      '3012249625',
      '1254510349',
      '2434106769',
      '1596738642',
      '2225741914',
      '7268730494',
      '9708950713',
      '2980632837',
      '3192425824',
      '9529174240',
      '9484125194',
      '6330599580',
      '1745183594',
      '3202201265',
      '7378395603',
      '5028262383',
      '6830758400',
      '7996726682',
      '6795636698',
      '4853507897',
      '6698262334',
      '9007620392',
      '3983492332',
      '8959852505',
      '4249216023',
      '8158275604',
      '6657539133',
      '7041419170',
      '3947545619',
      '6765397284',
      '3124201981',
      '9904077888',
      '7857043877',
      '6943407333') )
SELECT
  dup.Connect_ID,
  race_sum,
  D_384191091_D_384191091_D_412790539,
  D_384191091_D_384191091_D_458435048,
  D_384191091_D_384191091_D_583826374,
  D_384191091_D_384191091_D_586825330,
  D_384191091_D_384191091_D_973565052,
  D_384191091_D_384191091_D_636411467,
  D_384191091_D_384191091_D_706998638,
  D_384191091_D_384191091_D_746038746,
  D_384191091_D_384191091_D_807835037,
  #ARRAY_TO_STRING(variables, ", "),
  CASE
    WHEN race_sum = 1 AND (D_384191091_D_384191091_D_412790539 = '1') THEN "White"
    WHEN race_sum = 1
  AND (D_384191091_D_384191091_D_458435048 = '1') THEN "Black, African American, or African"
    WHEN race_sum = 1 AND (D_384191091_D_384191091_D_583826374 ='1') THEN "American Indian or Alaska Native"
    WHEN race_sum = 1
  AND (D_384191091_D_384191091_D_586825330 ='1') THEN "Hawaiian or other Pacific Islander"
    WHEN race_sum = 1 AND (D_384191091_D_384191091_D_636411467 ='1') THEN "Asian"
    WHEN race_sum = 1
  AND (D_384191091_D_384191091_D_706998638 ='1') THEN "Hispanic, Latino, or Spanish"
    WHEN race_sum = 1 AND (D_384191091_D_384191091_D_973565052 ='1') THEN "Middle Eastern or North African"
    WHEN race_sum = 1
  AND (D_384191091_D_384191091_D_807835037 ='1'
    AND D_384191091_D_747350323 IS NOT NULL) THEN "Other"
    WHEN race_sum = 1 AND (D_384191091_D_384191091_D_746038746 ='1') THEN "Skipped this question"
    WHEN race_sum > 1 THEN "Multi-race"
  ELSE
  "UNKNOWN"
END
  AS Race_Ethnic
FROM (
  SELECT
    Connect_ID,
    D_384191091_D_384191091_D_412790539,
    D_384191091_D_747350323,
    D_384191091_D_384191091_D_458435048,
    D_384191091_D_384191091_D_583826374,
    D_384191091_D_384191091_D_586825330,
    D_384191091_D_384191091_D_973565052,
    D_384191091_D_384191091_D_636411467,
    D_384191091_D_384191091_D_706998638,
    D_384191091_D_384191091_D_746038746,
    D_384191091_D_384191091_D_807835037,
    SUM(CAST(x AS int64)) AS race_sum
  FROM
    m1_dup,
    UNNEST([D_384191091_D_384191091_D_412790539, D_384191091_D_384191091_D_458435048, D_384191091_D_384191091_D_583826374, D_384191091_D_384191091_D_586825330, D_384191091_D_384191091_D_973565052, D_384191091_D_384191091_D_636411467, D_384191091_D_384191091_D_706998638, D_384191091_D_384191091_D_746038746, D_384191091_D_384191091_D_807835037]) AS x
  GROUP BY
    Connect_ID,
    D_384191091_D_384191091_D_412790539,
    D_384191091_D_384191091_D_458435048,
    D_384191091_D_384191091_D_583826374,
    D_384191091_D_384191091_D_586825330,
    D_384191091_D_384191091_D_973565052,
    D_384191091_D_747350323,
    D_384191091_D_384191091_D_636411467,
    D_384191091_D_384191091_D_706998638,
    D_384191091_D_384191091_D_746038746,
    D_384191091_D_384191091_D_807835037) AS dup
INNER JOIN
  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` AS p
ON
  dup.Connect_ID = p.Connect_ID
WHERE
  p.d_821247024 = '197316935'
  AND p.d_747006172 != '353358909'